# Migracija Baze Podataka i Prototip Chat Sesija

## Migracija baze podataka

### Integracija Supabase-a

U `settings.py` datoteci, postavke baze podataka su ažurirane kako bi koristile Supabase:

```python
DATABASES = {
    'default': {
        'ENGINE': os.environ['ENGINE'],
        'HOST': os.environ['HOST'],
        'NAME': os.environ['NAME'],
        'USER': os.environ['USER'],
        'PASSWORD': os.environ['PASSWORD'],
        'PORT': os.environ['PORT'],
    }
}
```

Ove postavke povlače konfiguraciju baze podataka iz varijabli okruženja pohranjenih u `.env` datoteci. Ova promjena omogućava Django aplikaciji da se poveže sa Supabase PostgreSQL bazom podataka.

### Tabela sa detaljima korisnika

Supabase ima tabelu `auth.users` za autentifikaciju, koja pohranjuje osnovne informacije o korisnicima kao što su email i enkriptovane lozinke. Međutim, nedostaju polja za dodatne informacije o korisnicima. Da bi se to riješilo, kreirana je nova tabela pod nazivom `user_detalji`:

```sql
create table public.user_detalji (
  id bigint generated by default as identity,
  created_at timestamp with time zone not null default now(),
  ime character varying not null,
  prezime character varying not null,
  user_id uuid null,
  constraint user_detalji_pkey primary key (id),
  constraint user_detalji_user_id_fkey foreign key (user_id) references auth.users (id) on delete cascade
) tablespace pg_default;
```

Ova tabela uključuje:
- `id`: Primarni ključ.
- `created_at`: Vrijeme kreiranja zapisa.
- `ime` i `prezime`: Ime i prezime korisnika.
- `user_id`: Strani ključ koji povezuje sa `auth.users`.

### Tabela sesija četa

Da bi se upravljalo sesijama četa, kreirana je tabela pod nazivom `chat_sesije`:

```sql
create table public.chat_sesije (
  id bigint generated by default as identity,
  created_at timestamp with time zone not null default now(),
  sesija_ime character varying not null,
  user_id uuid not null,
  constraint chat_sesije_pkey primary key (id),
  constraint chat_sesije_user_id_fkey foreign key (user_id) references auth.users (id) on delete cascade
) tablespace pg_default;
```

Ova tabela uključuje:
- `id`: Primarni ključ.
- `created_at`: Vrijeme kreiranja sesije.
- `sesija_ime`: Naziv sesije četa.
- `user_id`: Strani ključ koji povezuje sa `auth.users`.

### Tabela poruka

Za pohranu poruka razmijenjenih tokom sesija četa, kreirana je tabela pod nazivom `poruke`:

```sql
create table public.poruke (
  id bigint generated by default as identity,
  created_at timestamp with time zone not null default now(),
  chat_sesija_id bigint not null,
  poruka_text text not null,
  je_korisnik boolean not null default true,
  constraint poruke_pkey primary key (id),
  constraint poruke_chat_sesija_id_fkey foreign key (chat_sesija_id) references chat_sesije (id) on delete cascade
) tablespace pg_default;
```

Ova tabela uključuje:
- `id`: Primarni ključ.
- `created_at`: Vrijeme kreiranja poruke.
- `chat_sesija_id`: Strani ključ koji povezuje sa `chat_sesije`.
- `poruka_text`: Sadržaj poruke.
- `je_korisnik`: Booleova vrijednost koja označava da li je poruka od korisnika.

## Unapređenja Django aplikacije

### Bootstrap stilizacija

Bootstrap stilizacija je dodana u HTML datoteke za prijavu i registraciju kako bi se poboljšao UI/UX.

### Početna stranica

Kreirana je privremena početna stranica koja služi kao ulazna tačka za aplikaciju.

### Aplikacija za rukovanje upitima

Kreirana je nova Django aplikacija pod nazivom `prompting_handler` za upravljanje upitima i ponašanjem chatbot-a.

### Prikazi i forme

#### Prikazi

Datoteka `views.py` u `prompting_handler` aplikaciji sadrži sljedeći kod:

```python
from supabase import Client
import supabase
from ForgeAI_django import settings
from django.shortcuts import render, redirect
from .forms import ChatForm
from django.contrib import messages
from .data_klase import ChatSesija, Poruka

supabase: Client = settings.supabase

def index(request):
    user = request.session.get('user')
    if not user:
        messages.error(request, 'Morate biti prijavljeni da biste pristupili sesijama četa.')
        return redirect('login')
    
    response = supabase.table('chat_sesije').select('*').eq('user_id', user['id']).execute()
    chat_sessions_data = response.data
    
    chat_sessions = []
    for session_data in chat_sessions_data:
        chat_sessions.append(ChatSesija(
            id=session_data['id'],
            session_name=session_data['sesija_ime'],
            messages=[],
            created_at=session_data['created_at']
        ))

    return render(request, 'chatbot/index.html', {'chat_sessions': chat_sessions})

def chat_session(request, session_id):
    user = request.session.get('user')
    if not user:
        messages.error(request, 'Morate biti prijavljeni da biste pristupili ovoj sesiji četa.')
        return redirect('login')
    
    session_response = supabase.table('chat_sesije').select('*').eq('id', session_id).eq('user_id', user['id']).execute()
    
    if not session_response.data:
        messages.error(request, 'Sesija četa nije pronađena ili nemate dozvolu za pristup.')
        return redirect('index')
    
    session_data = session_response.data[0]
    chat_session = ChatSesija(
        id=session_data['id'],
        session_name=session_data['sesija_ime'],
        messages=[],
        created_at=session_data['created_at']
    )
    
    messages_response = supabase.table('poruke').select('*').eq('chat_sesija_id', session_id).order('created_at', desc=False).execute()
    messages_data = messages_response.data
    jeKorisnik = supabase.table('poruke').select('je_korisnik').eq('chat_sesija_id', session_id).execute()

    for message_data in messages_data:
        chat_session.messages.append(Poruka(
            message_text=message_data['poruka_text'],
            is_user=message_data['je_korisnik'],
            timestamp=message_data['created_at']
        ))
    
    if request.method == "POST":
        form = ChatForm(request.POST)
        if form.is_valid():
            user_input = form.cleaned_data['user_input']
            supabase.table('poruke').insert({'chat_sesija_id': session_id, 'poruka_text': user_input, 'je_korisnik': True}).execute()
            # Dodajte logiku za dobijanje odgovora bot-a
            bot_response = "Ovo je odgovor bot-a."
            supabase.table('poruke').insert({'chat_sesija_id': session_id, 'poruka_text': bot_response, 'je_korisnik': False}).execute()
            return redirect('chat_session', session_id=session_id)
    else:
        form = ChatForm
    return render(request, 'chatbot/chat_session.html', {'chat_session': chat_session, 'messages': messages, 'je_korisnik': jeKorisnik, 'form': form})

def create_session(request):
    user = request.session.get('user')
    if not user:
        messages.error(request, 'Morate biti prijavljeni da biste kreirali sesiju četa.')
        return redirect('login')
    
    if request.method == "POST":
        session_name = request.POST['session_name']
        response = supabase.table('chat_sesije').insert({'sesija_ime': session_name, 'user_id': user['id']}).execute()
        session_id = response.data[0]['id']
        return redirect('chat_session', session_id=session_id)
    return render(request, 'chatbot/create_session.html')
```

Objasnjenje:
- **index**: Prikazuje listu sesija četa za prijavljenog korisnika.
- **chat_session**: Prikazuje detalje određene sesije četa, uključujući poruke. Upravlja slanjem poruka i odgovorima bot-a.
- **create_session**: Omogućava prijavljenim korisnicima da kreiraju novu sesiju četa.

#### URL-ovi

Datoteka `urls.py` za `prompting_handler` aplikaciju:

```python
from django.contrib import admin
from django.urls import path
from prompting_handler import views

urlpatterns = [
    path('', views.index, name='index'),
    path('session/<int:session_id>/', views.chat_session, name='chat_session'),
    path('create/', views.create_session, name='create_session'),
]
```

Ovo postavlja rute za aplikaciju:
- `/`: Prikazuje sesije četa.
- `/session/<int:session_id>/`: Prikazuje određenu sesiju četa.
- `/create/`: Kreira novu sesiju četa.

#### Forma za čat

Klasa `ChatForm` u `forms.py`:

```python
from django import forms

class ChatForm(forms.Form):
    user_input = forms.CharField(widget=forms.Textarea(attrs={"rows": 3, "cols": 40}))
```

Objasnjenje:
- Definiše formu sa jednim poljem `user_input`, prikazanim kao textarea za poruke korisnika.

### Klase podataka

Dvije klase podataka, `Poruka` i `ChatSesija`, predstavljaju podatke dobijene iz baze podataka. One su definisane u `data_klase.py`:

```python
from dataclasses import dataclass
from typing import List

@dataclass
class Poruka:
    message_text: str
    is_user: bool
    timestamp: str

@dataclass
class ChatSesija:
    id: int
    session_name: str
    messages: List[Poruka]
    created_at: str
```

Objasnjenje:
- **Poruka**: Predstavlja poruku, uključujući tekst, pošiljaoca i vremensku oznaku.
- **ChatSesija**: Predstavlja sesiju četa, uključujući njen ID, naziv, listu poruka i vremensku oznaku kreiranja.

### HTML predlošci

#### Predložak za sesiju četa

`chat_session.html`:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Sesija četa - {{ chat_session.session_name }}</title>
</head>
<body>
    <h1>Sesija četa: {{ chat_session.session_name }}</h1>
    <div id="chat">
        {% for message in chat_session.messages %}
            <p><strong>
                {% if message.is_user %}
                    Korisnik
                {% else %}
                    OpenAI Bot
                {% endif %}
                :</strong> {{ message.message_text }} <small>({{ message.timestamp }})</small></p>
        {% endfor %}
    </div>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Pošalji</button>
    </form>
    <a href="{% url 'index' %}">Nazad na sesije</a>
</body>
</html>
```

Objasnjenje:
- Prikazuje naziv sesije četa i poruke.
- Pruža formu za korisnika da pošalje nove poruke.
- Uključuje link za povratak na listu sesija četa.

#### Predložak za kreiranje sesije

`create_session.html`:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Kreiranje nove sesije četa</title>
</head>
<body>
    <h1>Kreirajte novu sesiju četa</h1>
    <form method="post">
        {% csrf_token %}
        <label for="session_name">Naziv sesije:</label>
        <input type="text" id="session_name" name="session_name">
        <button type="submit">Kreiraj</button>
    </form>
    <a href="{% url 'index' %}">Nazad na sesije</a>
</body>
</html>
```

Objasnjenje:
- Pruža formu za kreiranje nove sesije četa sa nazivom.
- Uključuje link za povratak na listu sesija četa.

#### Indeks predložak

`index.html`:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Interfejs za četbot</title>
</head>
<body>
    <h1>Sesije četa</h1>
    <ul>
        {% for session in chat_sessions %}
            <li><a href="{% url 'chat_session' session.id %}">{{ session.session_name }}</a> (Kreirano: {{ session.created_at }})</li>
        {% endfor %}
    </ul>
    <a href="{% url 'create_session' %}">Kreirajte novu sesiju</a>
</body>
</html>
```

##### Objasnjenje:
- Prikazuje listu sesija četa sa linkovima ka svakoj sesiji.
- Uključuje link za kreiranje nove sesije četa.